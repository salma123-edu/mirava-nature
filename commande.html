<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finaliser la commande - MIRAVA NATURE</title>
  <link rel="stylesheet" href="css/style.css?v=3.1">
</head>

<body>
  <header>
    <div class="container">
      <a href="index.html"><img src="images/logo.png" alt="Logo Mirava Nature" /></a>
      <button class="mobile-menu-toggle">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <nav>
        <a href="index.html">Accueil</a>
        <a href="products.html">Produits</a>
        <a href="kits.html">Coffrets</a>
        <a href="contact.html">Contact</a>
        <div id="auth-nav-area"></div>
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="checkout-layout">
      <div class="checkout-main">
        <section class="checkout-section">
          <h2>Finaliser la commande</h2>
          <h3>RÃ©sumÃ© du panier</h3>
          <div id="items-list"></div>
          <div class="summary-row">
            <div>Sous-total</div>
            <div id="subtotal">0 DH</div>
          </div>

          <h3>Frais de livraison</h3>
          <div id="shipping-area">
            <div id="shipping-automatic" class="muted" style="display:none;">Frais de livraison : <strong
                id="shipping-amount">0 DH</strong></div>

            <div id="shipping-choices" style="display:none;">
              <div class="shipping-options">
                <label><input type="radio" name="shipping" value="30" /> Hors Rabat â€” 30 DH</label>
                <label><input type="radio" name="shipping" value="20" /> Sur Rabat â€” 20 DH</label>
              </div>
              <div class="muted">Choisissez votre zone pour calculer les frais.</div>
            </div>
          </div>
        </section>

        <section class="checkout-section">
          <h3>Vos informations</h3>
          <div class="form-group"><label>Nom complet</label><input id="cust-name" type="text"
              placeholder="Salma El ..." /></div>
          <div class="form-group"><label>Email</label><input id="cust-email" type="email"
              placeholder="votre@email.com" /></div>
          <div class="form-group"><label>TÃ©lÃ©phone</label><input id="cust-phone" type="text" placeholder="06..." />
          </div>
          <div class="form-group"><label>Adresse de livraison</label><textarea id="cust-address" rows="3"
              placeholder="Votre adresse complÃ¨te"></textarea></div>
        </section>
      </div>

      <aside class="summary-card">
        <h3>Total Ã  payer</h3>
        <div class="summary-row total">
          <div id="grand-total" style="font-size: 2rem;">0 DH</div>
        </div>
        <div style="margin-top:25px;">
          <button id="confirm-order" class="btn-premium" style="width:100%;">Confirmer la commande</button>
        </div>
        <p class="muted" style="margin-top:15px; text-align:center;">Paiement Ã  la livraison ðŸšš</p>
      </aside>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 MIRAVA NATURE</p>
    </div>
  </footer>

  <script src="products-data.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/main.js"></script>
  <script src="js/cart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const itemsList = document.getElementById('items-list');
      const subtotalEl = document.getElementById('subtotal');
      const shippingArea = document.getElementById('shipping-area');
      const shippingAutomatic = document.getElementById('shipping-automatic');
      const shippingChoices = document.getElementById('shipping-choices');
      const shippingAmountEl = document.getElementById('shipping-amount');
      const grandTotalEl = document.getElementById('grand-total');

      function format(d) { return d + ' DH'; }

      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      if (cart.length === 0) {
        itemsList.innerHTML = '<p>Votre panier est vide.</p>';
        subtotalEl.textContent = '';
        shippingAutomatic.style.display = 'none';
        shippingChoices.style.display = 'none';
        grandTotalEl.textContent = '0 DH';
        return;
      }

      // PrÃ©-remplir les infos si connectÃ©
      if (window.auth && window.auth.isLoggedIn()) {
        const user = window.auth.getUser();
        document.getElementById('cust-name').value = user.name || '';
        document.getElementById('cust-email').value = user.email || '';
      } else {
        // Si pas connectÃ© sur cette page, rediriger
        alert("Veuillez vous connecter pour voir cette page.");
        window.location.href = "login.html?redirect=commande.html";
        return;
      }

      // afficher items
      let subtotal = 0;
      itemsList.innerHTML = '';
      cart.forEach(it => {
        const row = document.createElement('div');
        row.className = 'summary-row';
        row.innerHTML = `<div>${it.name} Ã— ${it.qty}</div><div>${(it.price * it.qty)} DH</div>`;
        itemsList.appendChild(row);
        subtotal += (it.price || 0) * (it.qty || 0);
      });
      subtotalEl.textContent = format(subtotal);

      const threshold = 500;
      if (subtotal >= threshold) {
        // livraison gratuite
        shippingAutomatic.style.display = 'block';
        shippingChoices.style.display = 'none';
        shippingAmountEl.textContent = '0 DH';
        updateGrandTotal(0);
      } else {
        // proposer choix
        shippingAutomatic.style.display = 'none';
        shippingChoices.style.display = 'block';
        // prÃ©fÃ©rer Hors Rabat par dÃ©faut (30)
        const radios = document.getElementsByName('shipping');
        radios.forEach(r => r.checked = false);
        radios[0].checked = true;
        updateShippingFromChoice();
        radios.forEach(r => r.addEventListener('change', updateShippingFromChoice));
      }

      function updateShippingFromChoice() {
        const radios = document.getElementsByName('shipping');
        let fee = 0;
        for (const r of radios) { if (r.checked) { fee = parseFloat(r.value); break; } }
        shippingAmountEl.textContent = format(fee);
        updateGrandTotal(fee);
      }

      function updateGrandTotal(shippingFee) {
        const gt = subtotal + (shippingFee || 0);
        grandTotalEl.textContent = format(gt);
      }

      // confirme la commande
      document.getElementById('confirm-order').addEventListener('click', async () => {
        const nom = document.getElementById('cust-name').value.trim();
        const email = document.getElementById('cust-email').value.trim();
        const phone = document.getElementById('cust-phone').value.trim();
        const adresse = document.getElementById('cust-address').value.trim();
        if (!nom || !email || !phone || !adresse) { alert('Veuillez remplir tous les champs.'); return; }

        let shippingFee = 0;
        if (subtotal >= threshold) shippingFee = 0;
        else {
          const sel = document.querySelector('input[name="shipping"]:checked');
          shippingFee = sel ? parseFloat(sel.value) : 30;
        }

        const total = subtotal + shippingFee;
        const payload = {
          nom, email, telephone: phone, adresse, modePaiement: 'livraison',
          produits: cart, total, frais_livraison: shippingFee
        };

        try {
          const headers = { 'Content-Type': 'application/json' };
          const token = window.auth ? window.auth.getToken() : null;
          if (token) headers['Authorization'] = `Bearer ${token}`;

          const res = await fetch('/api/commandes', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload)
          });

          if (res.ok) {
            const data = await res.json();
            alert('Commande enregistrÃ©e. Merci !');
            localStorage.removeItem('cart');
            if (typeof window.updateCartUI === 'function') window.updateCartUI();
            location.href = `confirmation.html?id=${data.orderId || ''}`;
          } else {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.message || `Erreur serveur (${res.status})`);
          }
        } catch (err) {
          console.warn("Ã‰chec de la requÃªte API, passage en mode MOCK:", err.message);
          // MODE MOCK : On simule une rÃ©ussite pour la dÃ©monstration
          alert('Commande enregistrÃ©e (Mode DÃ©monstration). Merci !');
          localStorage.removeItem('cart');
          if (typeof window.updateCartUI === 'function') window.updateCartUI();
          // GÃ©nÃ©rer un ID fictif
          const mockId = 'MOCK-' + Math.random().toString(36).substr(2, 9).toUpperCase();
          location.href = `confirmation.html?id=${mockId}`;
        }
      });
    });
  </script>
</body>

</html>